<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For My Dearest Zanuu ‚ù§Ô∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Playfair+Display:wght@700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #ffc2e2, #f3d7ff);
            height: 100vh;
            overflow: hidden;
            color: #5a2a4e;
        }
        
        #app {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .step {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 10;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: none;
        }
        
        .step.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        
        .content-box {
            background: rgba(255, 255, 255, 0.7); /* Original blurry background */
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 800px;
            width: 90%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .emoji {
            font-size: 4rem;
            margin-bottom: 20px;
            display: inline-block;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        
        h1, h2 {
            font-family: 'Dancing Script', cursive;
            font-weight: 700;
            color: #b33971;
            margin-bottom: 20px;
            font-size: 3.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        p {
            font-size: 1.2rem;
            line-height: 1.7;
            margin-bottom: 25px;
            color: #5a2a4e;
        }
        
        .btn {
            background: linear-gradient(135deg, #ec4899, #d43f8d);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 8px 20px rgba(236, 72, 153, 0.4);
            transition: all 0.3s ease;
            width: 100%;
            max-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            z-index: 5;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(236, 72, 153, 0.5);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        #star-map-canvas {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            margin: 20px 0;
            width: 100%;
            height: 300px;
        }
        
        #candles-container {
            position: relative;
            width: 100%;
            height: 150px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin: 20px 0;
        }
        
        .cake {
            background: #d89669;
            width: 150px;
            height: 70px;
            border-radius: 10px 10px 0 0;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .icing {
            background: #fdf6e3;
            width: 160px;
            height: 15px;
            position: absolute;
            top: -15px;
            left: -5px;
            border-radius: 50%;
            box-shadow: inset 0 -3px 5px rgba(0, 0, 0, 0.1);
        }
        
        .candle {
            position: absolute;
            width: 10px;
            height: 40px;
            background: #fdf6e3;
            border-radius: 2px;
        }
        
        .flame {
            position: absolute;
            top: -20px;
            left: -1px;
            width: 12px;
            height: 25px;
            background: linear-gradient(to top, #ffcc33, #e65200);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 0 0 15px 8px rgba(255, 153, 0, 0.7);
            animation: flicker 1s infinite alternate;
        }
        
        @keyframes flicker {
            0% {
                transform: scale(1, 1.1) translateY(0);
                opacity: 1;
            }
            50% {
                transform: scale(1, 1) translateY(-2px);
                opacity: 0.9;
            }
            100% {
                transform: scale(1, 1.1) translateY(0);
                opacity: 1;
            }
        }
        
        .flame.out {
            animation: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        #blow-meter {
            height: 25px;
            width: 100%;
            max-width: 400px;
            background: #f0d5e0;
            border-radius: 15px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        
        #blow-level {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #f43f5e, #ec4899);
            border-radius: 15px;
            transition: width 0.1s ease-out;
            box-shadow: 0 0 10px rgba(236, 72, 153, 0.5);
        }
        
        /* Compliments container - original square boxes with scrolling */
        #compliments-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            grid-gap: 15px;
            padding: 15px;
            width: 100%;
            height: 300px; /* Fixed height for scrolling */
            margin: 20px 0;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
        }
        
        .floating-compliment {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            padding: 15px;
            font-size: 0.95rem;
            color: #5a2a4e;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            min-height: 80px;
        }
        
        .floating-compliment:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        
        .message-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            line-height: 1.8;
            margin-bottom: 30px;
            text-align: left;
            padding: 20px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .message-text p {
            margin-bottom: 20px;
            position: relative;
            padding-left: 20px;
        }
        
        .message-text p::before {
            content: "‚ù¶";
            position: absolute;
            left: 0;
            top: 0;
            color: #ec4899;
            font-size: 1.2rem;
        }
        
        .signature {
            font-family: 'Dancing Script', cursive;
            font-size: 2.5rem;
            color: #b33971;
            text-align: right;
            margin-top: 20px;
        }
        
        .progress-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 400px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ec4899, #f43f5e);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .content-box {
                padding: 20px;
            }
            
            h1, h2 {
                font-size: 2.5rem;
            }
            
            .emoji {
                font-size: 3rem;
            }
            
            p, .message-text {
                font-size: 1.1rem;
            }
            
            #star-map-canvas {
                height: 250px;
            }
            
            #compliments-container {
                height: 250px;
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
                grid-gap: 12px;
                padding: 10px;
            }
            
            .floating-compliment {
                padding: 12px;
                font-size: 0.9rem;
                min-height: 70px;
            }
            
            .btn {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
        }
        
        @media (max-width: 480px) {
            h1, h2 {
                font-size: 2rem;
            }
            
            .emoji {
                font-size: 2.5rem;
            }
            
            p, .message-text {
                font-size: 1rem;
            }
            
            #star-map-canvas {
                height: 200px;
            }
            
            #compliments-container {
                height: 200px;
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
                grid-gap: 10px;
                padding: 8px;
            }
            
            .floating-compliment {
                padding: 10px 8px;
                font-size: 0.8rem;
                min-height: 60px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="canvas-container"></div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="step active" id="step1">
            <div class="content-box">
                <div class="emoji">üíå</div>
                <h1>My Dearest Zanuu</h1>
                <p>A special message is waiting for you, my love. I poured my heart into creating something beautiful for your special day.</p>
                <p>You mean the world to me, and I want this birthday to be as magical as you are.</p>
                <button class="btn" id="start-btn">Open Your Gift üíñ</button>
            </div>
        </div>

        <div class="step" id="step2">
            <div class="content-box">
                <div class="emoji">üéÇ</div>
                <h1>Happy Birthday!</h1>
                <p>On this beautiful day, I want you to know how incredibly special you are to me. Your smile lights up my world, your laughter is my favorite melody, and your presence makes every moment magical.</p>
                <p>You are the most amazing person I've ever known, and I feel so blessed to have you in my life.</p>
                <button class="btn" id="next-btn-2">Words From My Heart üíå</button>
            </div>
        </div>

        <div class="step" id="step3">
            <div class="content-box">
                <div class="emoji">üíï</div>
                <h1>My Precious Zanuu</h1>
                <p>So many reasons why I adore you. Here are just a few:</p>
                
                <div id="compliments-container">
                    <div class="floating-compliment">Your beautiful smile üòä</div>
                    <div class="floating-compliment">Your kind heart ‚ù§Ô∏è</div>
                    <div class="floating-compliment">Your infectious laugh üòÑ</div>
                    <div class="floating-compliment">Your brilliant mind üß†</div>
                    <div class="floating-compliment">The way you make me feel safe ü§ó</div>
                    <div class="floating-compliment">Your incredible strength üí™</div>
                    <div class="floating-compliment">Your unwavering support üôå</div>
                    <div class="floating-compliment">Your unique perspective üåç</div>
                    <div class="floating-compliment">Your love for me ü•∞</div>
                    <div class="floating-compliment">Your sense of humor üòÇ</div>
                    <div class="floating-compliment">You are my sunshine ‚òÄÔ∏è</div>
                    <div class="floating-compliment">You make me better ‚ú®</div>
                    <div class="floating-compliment">Every day is a gift üéÅ</div>
                    <div class="floating-compliment">You are simply perfect üëë</div>
                    <div class="floating-compliment">Your beautiful eyes üëÄ</div>
                    <div class="floating-compliment">Your gentle touch ‚úã</div>
                    <div class="floating-compliment">Your positive energy üåü</div>
                    <div class="floating-compliment">Your caring nature ü§ó</div>
                    <div class="floating-compliment">Your amazing cooking üç≥</div>
                    <div class="floating-compliment">Your intelligence üß†</div>
                    <div class="floating-compliment">Your passion for life üî•</div>
                    <div class="floating-compliment">Your beautiful soul üí´</div>
                    <div class="floating-compliment">Your wise advice üí°</div>
                    <div class="floating-compliment">Your warm hugs ü§ó</div>
                </div>
                
                <button class="btn" id="next-btn-3">Our Special Sky üåå</button>
            </div>
        </div>

        <div class="step" id="step4">
            <div class="content-box">
                <div class="emoji">üå†</div>
                <h1>The Stars of Our Beginning</h1>
                <p>This is what the night sky looked like on <strong>June 10th</strong>, the day you came into my life and changed everything.</p>
                
                <canvas id="star-map-canvas"></canvas>
                
                <p>Our connection is written in the stars, my love. I knew from the moment we met that you were special.</p>
                <button class="btn" id="next-btn-4">Make a Wish! üå†</button>
            </div>
        </div>

        <div class="step" id="step5">
            <div class="content-box">
                <div class="emoji">üéÇ</div>
                <h1>Make a Wish!</h1>
                <p>Close your eyes, make a wish, and blow into your microphone to blow out the candles!</p>
                
                <div id="candles-container">
                    <div class="cake">
                        <div class="icing"></div>
                    </div>
                </div>
                
                <div id="blow-meter">
                    <div id="blow-level"></div>
                </div>
                
                <p id="blow-message" class="blow-message">Blow into your microphone to extinguish the candles!</p>
                
                <button class="btn" id="start-blow-btn">Start Blowing üéôÔ∏è</button>
                <button class="btn" id="manual-blow-btn">Click to Blow</button>
                <button class="btn hidden" id="next-btn-5">My Final Wish üôè</button>
            </div>
        </div>

        <div class="step" id="step6">
            <div class="content-box">
                <div class="emoji">üíñ</div>
                <h1>To My Beloved Zanuu</h1>
                
                <div class="message-text">
                    <p>My dearest love, on this special day, I want you to know how deeply you are cherished. Though distance may separate us, my heart is always with you, celebrating every beautiful moment of your existence.</p>
                    
                    <p>Your smile is the sunrise that brightens my darkest days, your laughter the melody that fills my soul with joy. I wish I could be there to hold you close, to see that perfect smile in person, and to whisper these words directly into your ear.</p>
                    
                    <p>You are my reason to believe in forever, my sanctuary in a chaotic world, and my greatest blessing. No matter the miles between us, you remain the closest to my heart, the star that guides me home.</p>
                    
                    <p>May this year bring you as much happiness as you've given me, and may all your dreams take flight. I eagerly await the day when I can look into your beautiful eyes and tell you in person how much you mean to me.</p>
                    
                    <p>May Allah bless you with everything your heart desires, and may your life be filled with joy, love, and prosperity. You deserve all the happiness in the world, my precious zanuu.</p>
                    
                    <p>With all my love, forever and always.</p>
                </div>
                
                <div class="signature">Your Love</div>
                
                <button class="btn" id="confetti-btn">Celebrate Us! üéâ</button>
            </div>
        </div>
    </div>

    <script>
        // Three.js Heart Background (original)
        const container = document.getElementById('canvas-container');
        const renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 30;

        // Heart Geometry
        const heartShape = new THREE.Shape();
        heartShape.moveTo(0.5, 0.5);
        heartShape.bezierCurveTo(0.5, 0.5, 1, 0, 0, 0);
        heartShape.bezierCurveTo(-1, 0, -1, 1.5, -1, 1.5);
        heartShape.bezierCurveTo(-1, 2.5, 0.5, 3.5, 0.5, 3.5);
        heartShape.bezierCurveTo(0.5, 3.5, 2, 2.5, 2, 1.5);
        heartShape.bezierCurveTo(2, 1.5, 2, 0, 1, 0);
        heartShape.bezierCurveTo(0.5, 0, 0.5, 0.5, 0.5, 0.5);

        const extrudeSettings = {
            depth: 0.5,
            bevelEnabled: true,
            bevelSegments: 3,
            bevelSize: 0.2,
            bevelThickness: 0.3
        };

        const heartGeometry = new THREE.ExtrudeGeometry(heartShape, extrudeSettings);

        // Create hearts for background
        const hearts = [];
        const colors = [
            0xff6b6b, 0xff8e8e, 0xffb3b3, 0xffd8d8,
            0xff9e9e, 0xffc1c1, 0xff6b8e, 0xff8eb3
        ];

        for (let i = 0; i < 30; i++) {
            const material = new THREE.MeshPhongMaterial({
                color: colors[Math.floor(Math.random() * colors.length)],
                emissive: 0xff0000,
                emissiveIntensity: 0.1,
                shininess: 100,
                transparent: true,
                opacity: 0.8
            });

            const heart = new THREE.Mesh(heartGeometry, material);

            // Random position and scale
            heart.position.x = (Math.random() - 0.5) * 100;
            heart.position.y = (Math.random() - 0.5) * 100;
            heart.position.z = (Math.random() - 0.5) * 100;

            const scale = Math.random() * 1 + 0.5;
            heart.scale.set(scale, scale, scale);

            // Random rotation
            heart.rotation.x = Math.random() * Math.PI;
            heart.rotation.y = Math.random() * Math.PI;

            // Store animation properties
            heart.userData = {
                speedX: Math.random() * 0.02 - 0.01,
                speedY: Math.random() * 0.02 - 0.01,
                speedZ: Math.random() * 0.02 - 0.01,
                rotationSpeedX: Math.random() * 0.01,
                rotationSpeedY: Math.random() * 0.01,
                originalX: heart.position.x,
                originalY: heart.position.y,
                originalZ: heart.position.z,
                floatDistance: 2 + Math.random() * 3
            };

            scene.add(heart);
            hearts.push(heart);
        }

        // Add lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);

        // Animation loop for heart background
        function animate() {
            requestAnimationFrame(animate);
            hearts.forEach(heart => {
                const time = Date.now() * 0.001;
                heart.position.x = heart.userData.originalX + Math.sin(time * heart.userData.speedX * 10) * heart.userData.floatDistance;
                heart.position.y = heart.userData.originalY + Math.sin(time * heart.userData.speedY * 10) * heart.userData.floatDistance;
                heart.position.z = heart.userData.originalZ + Math.sin(time * heart.userData.speedZ * 10) * heart.userData.floatDistance;
                heart.rotation.x += heart.userData.rotationSpeedX;
                heart.rotation.y += heart.userData.rotationSpeedY;
            });
            renderer.render(scene, camera);
        }
        animate();

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Star Map Logic
        let starMapScene, starMapCamera, starMapRenderer;
        let isDragging = false;
        let previousMousePosition = {
            x: 0,
            y: 0
        };
        const starCount = 500;

        function initStarMap() {
            const starMapContainer = document.getElementById('star-map-container');
            const starMapCanvas = document.getElementById('star-map-canvas');

            const width = starMapContainer.offsetWidth;
            const height = 300;

            starMapRenderer = new THREE.WebGLRenderer({
                canvas: starMapCanvas,
                antialias: true,
                alpha: true
            });
            starMapRenderer.setSize(width, height);

            starMapScene = new THREE.Scene();
            starMapCamera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            starMapCamera.position.z = 5;

            // Generate a starry night sky
            const starGeometry = new THREE.BufferGeometry();
            const starVertices = [];
            for (let i = 0; i < starCount; i++) {
                const x = (Math.random() - 0.5) * 100;
                const y = (Math.random() - 0.5) * 100;
                const z = (Math.random() - 0.5) * 100;
                starVertices.push(x, y, z);
            }
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            const starMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.1,
                sizeAttenuation: true
            });
            const starField = new THREE.Points(starGeometry, starMaterial);
            starMapScene.add(starField);

            // Create a constellation line to represent a connection
            const lineMaterial = new THREE.LineBasicMaterial({
                color: 0xff69b4,
                linewidth: 3,
                opacity: 0.8,
                transparent: true
            });
            const points = [];
            points.push(new THREE.Vector3(-2, 1, -1));
            points.push(new THREE.Vector3(0, 2, 0));
            points.push(new THREE.Vector3(2, 1, 1));
            points.push(new THREE.Vector3(1, -2, 2));
            points.push(new THREE.Vector3(-1, -1, -2));
            const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
            const line = new THREE.Line(lineGeometry, lineMaterial);
            starMapScene.add(line);

            // Animation loop for star map
            const animateStarMap = () => {
                requestAnimationFrame(animateStarMap);
                if (!isDragging) {
                    starMapScene.rotation.y += 0.001;
                }
                starMapRenderer.render(starMapScene, starMapCamera);
            };
            animateStarMap();

            // Mouse interaction for star map
            starMapCanvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = {
                    x: e.clientX,
                    y: e.clientY
                };
            });
            starMapCanvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            starMapCanvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaMove = {
                        x: e.clientX - previousMousePosition.x,
                        y: e.clientY - previousMousePosition.y
                    };
                    starMapScene.rotation.y += deltaMove.x * 0.005;
                    starMapScene.rotation.x += deltaMove.y * 0.005;
                    previousMousePosition = {
                        x: e.clientX,
                        y: e.clientY
                    };
                }
            });
            
            // Touch events for mobile
            starMapCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDragging = true;
                previousMousePosition = {
                    x: e.touches[0].clientX,
                    y: e.touches[0].clientY
                };
            });
            starMapCanvas.addEventListener('touchend', () => {
                isDragging = false;
            });
            starMapCanvas.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    const deltaMove = {
                        x: e.touches[0].clientX - previousMousePosition.x,
                        y: e.touches[0].clientY - previousMousePosition.y
                    };
                    starMapScene.rotation.y += deltaMove.x * 0.005;
                    starMapScene.rotation.x += deltaMove.y * 0.005;
                    previousMousePosition = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY
                    };
                    e.preventDefault();
                }
            });
            
            window.addEventListener('resize', () => {
                const newWidth = starMapContainer.offsetWidth;
                starMapCamera.aspect = newWidth / height;
                starMapCamera.updateProjectionMatrix();
                starMapRenderer.setSize(newWidth, height);
            });
        }

        // Create candles
        function createCandles() {
            const cake = document.querySelector('.cake');
            const candlePositions = [
                { top: -20, left: '20%' },
                { top: -25, left: '50%' },
                { top: -20, left: '80%' },
            ];

            candlePositions.forEach(pos => {
                const candleDiv = document.createElement('div');
                candleDiv.className = 'candle';
                candleDiv.style.top = `${pos.top}px`;
                candleDiv.style.left = pos.left;

                const flameDiv = document.createElement('div');
                flameDiv.className = 'flame';
                candleDiv.appendChild(flameDiv);

                cake.appendChild(candleDiv);
            });
        }
        createCandles();
        
        // Candle blowing logic
        let audioContext, analyser, microphone, stream;
        let isBlowing = false;
        const blowThreshold = 20;
        const candles = document.querySelectorAll('.flame');
        
        function blowOutCandles() {
            isBlowing = true;
            document.getElementById('blow-message').textContent = "You blew out the candles! üéâ";
            candles.forEach(flame => {
                flame.classList.add('out');
            });

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            setTimeout(() => {
                document.getElementById('next-btn-5').classList.remove('hidden');
                document.getElementById('start-blow-btn').classList.add('hidden');
                document.getElementById('manual-blow-btn').classList.add('hidden');
            }, 1000);
        }

        function startBlowingLogic() {
            const blowMessage = document.getElementById('blow-message');
            const blowLevelBar = document.getElementById('blow-level');

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                blowMessage.textContent = "Microphone access is not supported on this browser.";
                return;
            }

            navigator.mediaDevices.getUserMedia({
                    audio: true
                })
                .then(function(s) {
                    stream = s;
                    audioContext = new(window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    microphone = audioContext.createMediaStreamSource(stream);
                    analyser.minDecibels = -90;
                    analyser.maxDecibels = -10;
                    analyser.smoothingTimeConstant = 0.85;
                    microphone.connect(analyser);

                    const dataArray = new Uint8Array(analyser.fftSize);

                    blowMessage.textContent = "Permission granted! Blow now! üå¨Ô∏è";

                    const checkBlow = () => {
                        analyser.getByteFrequencyData(dataArray);
                        const volume = dataArray.reduce((acc, val) => acc + val, 0) / dataArray.length;

                        // Update the visual blow meter
                        blowLevelBar.style.width = `${Math.min(volume, 255) / 2.55}%`;

                        if (volume > blowThreshold && !isBlowing) {
                            blowOutCandles();
                        }

                        if (!isBlowing) {
                            requestAnimationFrame(checkBlow);
                        }
                    };
                    checkBlow();
                })
                .catch(function(err) {
                    blowMessage.textContent = "Microphone access denied. Please allow permission to blow out the candles.";
                    console.error("Error accessing microphone:", err);
                });
        }

        // Step Navigation
        let currentStep = 1;
        const totalSteps = 6;
        
        function updateProgressBar() {
            const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }
        
        function showStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(`step${stepNumber}`).classList.add('active');
            updateProgressBar();
            
            if (stepNumber === 4 && !starMapScene) {
                initStarMap();
            }
            
            if (stepNumber === 5) {
                isBlowing = false;
                candles.forEach(flame => flame.classList.remove('out'));
                document.getElementById('blow-level').style.width = '0%';
                document.getElementById('blow-message').textContent = 'Blow into your microphone to extinguish the candles!';
                document.getElementById('next-btn-5').classList.add('hidden');
                document.getElementById('start-blow-btn').classList.remove('hidden');
                document.getElementById('manual-blow-btn').classList.remove('hidden');
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
            }
            
            // Special effects for step 6
            if(stepNumber === 6) {
                confetti({
                    particleCount: 30,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#ff6b9c', '#ff8eb3', '#ffc2d6']
                });
            }
        }
        
        // Navigation event listeners
        document.getElementById('start-btn').addEventListener('click', () => {
            currentStep = 2;
            showStep(currentStep);
        });
        
        document.getElementById('next-btn-2').addEventListener('click', () => {
            currentStep = 3;
            showStep(currentStep);
        });
        
        document.getElementById('next-btn-3').addEventListener('click', () => {
            currentStep = 4;
            showStep(currentStep);
        });
        
        document.getElementById('next-btn-4').addEventListener('click', () => {
            currentStep = 5;
            showStep(currentStep);
        });
        
        document.getElementById('next-btn-5').addEventListener('click', () => {
            currentStep = 6;
            showStep(currentStep);
        });
        
        // Candle blowing buttons
        document.getElementById('start-blow-btn').addEventListener('click', () => {
            document.getElementById('start-blow-btn').disabled = true;
            startBlowingLogic();
        });
        
        document.getElementById('manual-blow-btn').addEventListener('click', () => {
            blowOutCandles();
        });
        
        // Confetti button
        document.getElementById('confetti-btn').addEventListener('click', () => {
            // Heart-shaped confetti
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                shapes: ['heart'],
                colors: ['#ff6b9c', '#ff8eb3', '#ffc2d6']
            });
            
            // Additional celebration
            setTimeout(() => {
                confetti({
                    particleCount: 100,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#ff6b9c', '#ff8eb3']
                });
                
                confetti({
                    particleCount: 100,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#ff6b9c', '#ff8eb3']
                });
            }, 300);
        });
        
        // Initialize
        updateProgressBar();
    </script>
</body>
</html>
