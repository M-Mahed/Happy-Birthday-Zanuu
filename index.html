<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For Moi Zanuuu ‚ù§Ô∏è</title>
    <!-- CSS and JS libraries for styling, animation, and effects -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            touch-action: manipulation;
            background: linear-gradient(135deg, #f9a8d4, #f3e8ff);
        }

        #app {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #content {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .step {
            position: absolute;
            width: 90%;
            max-width: 800px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.509);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: none;
            display: none;
        }

        .step.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #ec4899, #f43f5e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
            transition: all 0.3s ease;
            width: 100%;
            max-width: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(236, 72, 153, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-small {
            background: #f87171;
            padding: 8px 16px;
            font-size: 0.875rem;
            max-width: 200px;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(248, 113, 113, 0.3);
        }

        .text-gradient {
            background: linear-gradient(135deg, #ec4899, #f43f5e, #f59e0b);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .animated-title {
            animation: pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-glow {
            0%,
            100% {
                transform: scale(1);
                text-shadow: 0 0 5px rgba(236, 72, 153, 0.3);
            }
            50% {
                transform: scale(1.05);
                text-shadow: 0 0 15px rgba(236, 72, 153, 0.6);
            }
        }

        .emoji {
            font-size: 3rem;
            margin-bottom: 20px;
            display: inline-block;
        }

        #progress-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 400px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            z-index: 100;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ec4899, #f43f5e);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Star map specific styles */
        #star-map-canvas {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        /* Message box styles */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease;
        }

        .message-box.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Birthday list item styling */
        .birthday-list-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 12px 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
            max-width: 500px;
        }

        .birthday-list-item:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        /* Blow out candles section styles */
        #candles-container {
            position: relative;
            width: 100%;
            height: 150px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 20px;
        }

        .cake {
            background: #d89669;
            width: 120px;
            height: 60px;
            border-radius: 10px 10px 0 0;
            position: relative;
        }

        .icing {
            background: #fdf6e3;
            width: 130px;
            height: 10px;
            position: absolute;
            top: -10px;
            left: -5px;
            border-radius: 50%;
            box-shadow: inset 0 -3px 5px rgba(0, 0, 0, 0.1);
        }

        .candle {
            position: absolute;
            width: 8px;
            height: 30px;
            background: #fdf6e3;
            border-radius: 2px;
        }

        .flame {
            position: absolute;
            top: -15px;
            left: -1px;
            width: 10px;
            height: 20px;
            background: linear-gradient(to top, #ffcc33, #e65200);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 0 0 10px 5px rgba(255, 153, 0, 0.7);
            animation: flicker 1s infinite alternate;
        }

        @keyframes flicker {
            0% {
                transform: scale(1, 1.1) translateY(0);
                opacity: 1;
            }
            50% {
                transform: scale(1, 1) translateY(-2px);
                opacity: 0.9;
            }
            100% {
                transform: scale(1, 1.1) translateY(0);
                opacity: 1;
            }
        }

        .flame.out {
            animation: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #blow-meter {
            height: 20px;
            width: 100%;
            max-width: 300px;
            background: #ddd;
            border-radius: 10px;
            margin-top: 20px;
            position: relative;
        }

        #blow-level {
            height: 100%;
            width: 0%;
            background: #f43f5e;
            border-radius: 10px;
            transition: width 0.1s ease-out;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="canvas-container"></div>

        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>

        <div id="message-box" class="message-box"></div>

        <div id="content">
            <!-- Step 1: Initial Reveal -->
            <div class="step active" id="step1">
                <div class="emoji heart-beat">‚ù§Ô∏è</div>
                <h1 class="text-4xl md:text-5xl font-bold mb-6 text-gradient animated-title">Hey Zanuuu</h1>
                <p class="text-lg text-gray-700 mb-8 md:text-xl">I made something special for you... ‚ú®</p>
                <button class="btn" id="start-btn">Let's Begin üéâ</button>
            </div>

            <!-- Step 2: Birthday Message -->
            <div class="step" id="step2">
                <div class="emoji">üéÇ</div>
                <h2 class="text-3xl md:text-4xl font-bold mb-6 text-gradient">Happy Birthday!</h2>
                <p class="text-base text-gray-700 mb-6 md:text-lg">
                    On your special day, I want you to know how amazing you are. Your smile brightens my world, your
                    laughter is my favorite melody, and your presence makes every moment magical.
                </p>
                <button class="btn" id="next-btn-2">A few words for you üíñ</button>
            </div>

            <!-- Step 3: Three Things About You -->
            <div class="step" id="step3">
                <div class="emoji">üëë</div>
                <h2 class="text-3xl md:text-4xl font-bold mb-6 text-gradient">Some words for moi Zanuu</h2>
                <p class="text-base text-gray-700 mb-8 md:text-lg">
                    Just a few of the countless reasons why you are so special to me.
                </p>
                <div class="w-full flex flex-col items-center">
                    <div class="birthday-list-item">
                        <span class="font-semibold text-pink-600">Your kind heart:</span> You care so deeply for everyone around you, and it inspires me every single day.
                    </div>
                    <div class="birthday-list-item">
                        <span class="font-semibold text-pink-600">Your brilliant mind:</span> I love the way you see the world and the way you think about things.
                    </div>
                    <div class="birthday-list-item">
                        <span class="font-semibold text-pink-600">Your infectious laugh:</span> Hearing you laugh is one of my favorite sounds in the entire world.
                    </div>
                </div>
                <button class="btn" id="next-btn-3">A Glimpse into the Sky üî≠</button>
            </div>

            <!-- Step 4: Star Map -->
            <div class="step" id="step4">
                <div class="emoji">üåå</div>
                <h2 class="text-3xl md:text-4xl font-bold mb-6 text-gradient">The Stars of Our Beginning</h2>
                <p class="text-base text-gray-700 mb-6 md:text-lg">
                    This is what the night sky looked like on **June 10th**, the day you came into my life. ‚ú®
                </p>
                <div id="star-map-container" class="w-full h-64 md:h-96 relative rounded-xl mb-4">
                    <canvas id="star-map-canvas" class="w-full h-full"></canvas>
                </div>
                <p class="text-sm text-gray-500 italic mt-2">
                    Click and drag to explore the sky!
                </p>
                <button class="btn" id="next-btn-4">Make a Wish üéÅ</button>
            </div>

            <!-- Step 5: Blow Out the Candles -->
            <div class="step" id="step5">
                <div class="emoji">üïØÔ∏è</div>
                <h2 class="text-3xl md:text-4xl font-bold mb-6 text-gradient">Make a Wish!</h2>
                <p class="text-base text-gray-700 mb-6 md:text-lg">
                    Close your eyes, make a wish, and blow into your microphone to blow out the candles!
                </p>
                <div id="candles-container">
                    <div class="cake">
                        <div class="icing"></div>
                        <!-- Candles will be positioned here -->
                    </div>
                </div>
                <div id="blow-meter">
                    <div id="blow-level"></div>
                </div>
                <p id="blow-message" class="mt-4 text-gray-700 text-sm italic"></p>
                <div class="flex flex-col items-center w-full">
                    <button class="btn w-full max-w-sm" id="start-blow-btn">Start Blowing üéôÔ∏è</button>
                    <!-- Small button to manually blow out candles -->
                    <button class="btn btn-small" id="manual-blow-btn">Click to Blow</button>
                    <button class="btn hidden w-full max-w-sm" id="next-btn-5">One Last Thing üôè</button>
                </div>
            </div>


            <!-- Step 6: Final Wish -->
            <div class="step" id="step6">
                <div class="emoji">ü•≥</div>
                <h2 class="text-3xl md:text-4xl font-bold mb-6 text-gradient">Birthday Wish For You</h2>
                <p class="text-base text-gray-700 mb-8 md:text-lg">
                    Happy Birthday, my love ‚ù§Ô∏è Even though miles separate us today, my heart is right there with you,
                    celebrating every beautiful thing about you. I wish I could hold you close and see that perfect
                    smile in person, but until that day comes, I‚Äôll keep sending you my love across every distance. You
                    are my reason to believe in forever, my safe place, and my greatest blessing. No matter how far we
                    are, you‚Äôre always the closest thing to me. I hope this year brings you as much happiness as you‚Äôve
                    given me, and I can‚Äôt wait for the day when I can say these words to you while looking into your
                    eyes ayeee shammu arai .May Allah bless you with everything you wished for and be happy moi lil zanuuu
                    Ummmaahhhhhüíã!
                </p>
                <p class="text-lg font-semibold text-pink-600 mb-8 md:text-xl">
                    Happy Birthday, my zanuuu! ‚ù§Ô∏è
                </p>
                <button class="btn" id="confetti-btn">Celebrate! üéâ</button>
                <p class="mt-8 text-sm text-gray-500">Made with ‚ù§Ô∏è just for you</p>
            </div>
        </div>
    </div>

    <script>
        // Custom message box for alerts
        function showMessage(message, duration = 3000) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.classList.add('visible');
            setTimeout(() => {
                messageBox.classList.remove('visible');
            }, duration);
        }

        // Three.js Heart Background
        const container = document.getElementById('canvas-container');
        const renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 30;

        // Improved Heart Geometry
        const x = 0,
            y = 0;
        const heartShape = new THREE.Shape();
        heartShape.moveTo(x + 0.5, y + 0.5);
        heartShape.bezierCurveTo(x + 0.5, y + 0.5, x + 1, y, x, y);
        heartShape.bezierCurveTo(x - 1, y, x - 1, y + 1.5, x - 1, y + 1.5);
        heartShape.bezierCurveTo(x - 1, y + 2.5, x + 0.5, y + 3.5, x + 0.5, y + 3.5);
        heartShape.bezierCurveTo(x + 0.5, y + 3.5, x + 2, y + 2.5, x + 2, y + 1.5);
        heartShape.bezierCurveTo(x + 2, y + 1.5, x + 2, y, x + 1, y);
        heartShape.bezierCurveTo(x + 0.5, y, x + 0.5, y + 0.5, x + 0.5, y + 0.5);

        const extrudeSettings = {
            depth: 0.5,
            bevelEnabled: true,
            bevelSegments: 3,
            bevelSize: 0.2,
            bevelThickness: 0.3
        };

        const heartGeometry = new THREE.ExtrudeGeometry(heartShape, extrudeSettings);

        // Create multiple hearts with different colors and properties
        const hearts = [];
        const colors = [
            0xff6b6b, 0xff8e8e, 0xffb3b3, 0xffd8d8,
            0xff9e9e, 0xffc1c1, 0xff6b8e, 0xff8eb3
        ];

        for (let i = 0; i < 25; i++) {
            const material = new THREE.MeshPhongMaterial({
                color: colors[Math.floor(Math.random() * colors.length)],
                emissive: 0xff0000,
                emissiveIntensity: 0.1,
                shininess: 100,
                transparent: true,
                opacity: 0.9
            });

            const heart = new THREE.Mesh(heartGeometry, material);

            // Random position and scale
            heart.position.x = (Math.random() - 0.5) * 50;
            heart.position.y = (Math.random() - 0.5) * 50;
            heart.position.z = (Math.random() - 0.5) * 50;

            const scale = Math.random() * 0.8 + 0.5;
            heart.scale.set(scale, scale, scale);

            // Random rotation
            heart.rotation.x = Math.random() * Math.PI;
            heart.rotation.y = Math.random() * Math.PI;

            // Store animation properties
            heart.userData = {
                speedX: Math.random() * 0.02 - 0.01,
                speedY: Math.random() * 0.02 - 0.01,
                speedZ: Math.random() * 0.02 - 0.01,
                rotationSpeedX: Math.random() * 0.01,
                rotationSpeedY: Math.random() * 0.01,
                originalX: heart.position.x,
                originalY: heart.position.y,
                originalZ: heart.position.z,
                floatDistance: 2 + Math.random() * 3
            };

            scene.add(heart);
            hearts.push(heart);
        }

        // Add lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);

        // Animation loop for heart background
        function animate() {
            requestAnimationFrame(animate);
            hearts.forEach(heart => {
                const time = Date.now() * 0.001;
                heart.position.x = heart.userData.originalX + Math.sin(time * heart.userData.speedX * 10) * heart.userData.floatDistance;
                heart.position.y = heart.userData.originalY + Math.sin(time * heart.userData.speedY * 10) * heart.userData.floatDistance;
                heart.position.z = heart.userData.originalZ + Math.sin(time * heart.userData.speedZ * 10) * heart.userData.floatDistance;
                heart.rotation.x += heart.userData.rotationSpeedX;
                heart.rotation.y += heart.userData.rotationSpeedY;
            });
            renderer.render(scene, camera);
        }
        animate();

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Star Map Logic
        let starMapScene, starMapCamera, starMapRenderer;
        let isDragging = false;
        let previousMousePosition = {
            x: 0,
            y: 0
        };
        const starCount = 500;

        function initStarMap() {
            const starMapContainer = document.getElementById('star-map-container');
            const starMapCanvas = document.getElementById('star-map-canvas');

            const width = starMapContainer.offsetWidth;
            const height = starMapContainer.offsetHeight;

            starMapRenderer = new THREE.WebGLRenderer({
                canvas: starMapCanvas,
                antialias: true,
                alpha: true
            });
            starMapRenderer.setSize(width, height);

            starMapScene = new THREE.Scene();
            starMapCamera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            starMapCamera.position.z = 5;

            // Generate a starry night sky
            const starGeometry = new THREE.BufferGeometry();
            const starVertices = [];
            for (let i = 0; i < starCount; i++) {
                const x = (Math.random() - 0.5) * 100;
                const y = (Math.random() - 0.5) * 100;
                const z = (Math.random() - 0.5) * 100;
                starVertices.push(x, y, z);
            }
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            const starMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.1,
                sizeAttenuation: true
            });
            const starField = new THREE.Points(starGeometry, starMaterial);
            starMapScene.add(starField);

            // Create a constellation line to represent a connection
            const lineMaterial = new THREE.LineBasicMaterial({
                color: 0xff69b4,
                linewidth: 2,
                opacity: 0.8,
                transparent: true
            });
            const points = [];
            points.push(new THREE.Vector3(-2, 1, -1));
            points.push(new THREE.Vector3(0, 2, 0));
            points.push(new THREE.Vector3(2, 1, 1));
            points.push(new THREE.Vector3(1, -2, 2));
            points.push(new THREE.Vector3(-1, -1, -2));
            const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
            const line = new THREE.Line(lineGeometry, lineMaterial);
            starMapScene.add(line);

            // Animation loop for star map
            const animateStarMap = () => {
                requestAnimationFrame(animateStarMap);
                if (!isDragging) {
                    starMapScene.rotation.y += 0.001;
                }
                starMapRenderer.render(starMapScene, starMapCamera);
            };
            animateStarMap();

            // Mouse interaction for star map
            starMapCanvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = {
                    x: e.clientX,
                    y: e.clientY
                };
            });
            starMapCanvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            starMapCanvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaMove = {
                        x: e.clientX - previousMousePosition.x,
                        y: e.clientY - previousMousePosition.y
                    };
                    starMapScene.rotation.y += deltaMove.x * 0.005;
                    starMapScene.rotation.x += deltaMove.y * 0.005;
                    previousMousePosition = {
                        x: e.clientX,
                        y: e.clientY
                    };
                }
            });
            window.addEventListener('resize', () => {
                const newWidth = starMapContainer.offsetWidth;
                const newHeight = starMapContainer.offsetHeight;
                starMapCamera.aspect = newWidth / newHeight;
                starMapCamera.updateProjectionMatrix();
                starMapRenderer.setSize(newWidth, newHeight);
            });
        }

        // ===============================================
        // Candle Blowing Logic
        // ===============================================
        let audioContext, analyser, microphone, stream;
        let isBlowing = false;
        // The blow threshold is set to a low value for a light blow.
        // You can adjust this value (e.g., 20-100) to change the sensitivity.
        const blowThreshold = 20;
        const candles = [];

        function createCandles() {
            const cake = document.querySelector('.cake');
            const candlePositions = [
                {
                    top: -20,
                    left: '20%'
                },
                {
                    top: -25,
                    left: '50%'
                },
                {
                    top: -20,
                    left: '80%'
                },
            ];

            candlePositions.forEach(pos => {
                const candleDiv = document.createElement('div');
                candleDiv.className = 'candle';
                candleDiv.style.top = `${pos.top}px`;
                candleDiv.style.left = pos.left;

                const flameDiv = document.createElement('div');
                flameDiv.className = 'flame';
                candleDiv.appendChild(flameDiv);

                cake.appendChild(candleDiv);
                candles.push(flameDiv);
            });
        }
        createCandles();

        function blowOutCandles() {
            // Function to blow out all candles and stop the logic
            isBlowing = true;
            document.getElementById('blow-message').textContent = "You blew out the candles! üéâ";
            candles.forEach(flame => {
                flame.classList.add('out');
            });

            // Stop the microphone stream if it's running
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            // Wait a moment then show the next button and hide the current buttons
            setTimeout(() => {
                document.getElementById('next-btn-5').classList.remove('hidden');
                document.getElementById('start-blow-btn').classList.add('hidden');
                document.getElementById('manual-blow-btn').classList.add('hidden');
            }, 1000);
        }

        function startBlowingLogic() {
            const blowMessage = document.getElementById('blow-message');
            const blowLevelBar = document.getElementById('blow-level');

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                blowMessage.textContent = "Microphone access is not supported on this browser.";
                return;
            }

            navigator.mediaDevices.getUserMedia({
                    audio: true
                })
                .then(function(s) {
                    stream = s;
                    audioContext = new(window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    microphone = audioContext.createMediaStreamSource(stream);
                    analyser.minDecibels = -90;
                    analyser.maxDecibels = -10;
                    analyser.smoothingTimeConstant = 0.85;
                    microphone.connect(analyser);

                    const dataArray = new Uint8Array(analyser.fftSize);

                    blowMessage.textContent = "Permission granted! Blow now! üå¨Ô∏è";

                    const checkBlow = () => {
                        analyser.getByteFrequencyData(dataArray);
                        const volume = dataArray.reduce((acc, val) => acc + val, 0) / dataArray.length;

                        // Update the visual blow meter
                        blowLevelBar.style.width = `${Math.min(volume, 255) / 2.55}%`;

                        if (volume > blowThreshold && !isBlowing) {
                            blowOutCandles();
                        }

                        if (!isBlowing) {
                            requestAnimationFrame(checkBlow);
                        }
                    };
                    checkBlow();
                })
                .catch(function(err) {
                    blowMessage.textContent = "Microphone access denied. Please allow permission to blow out the candles.";
                    console.error("Error accessing microphone:", err);
                });
        }

        // ===============================================
        // Step Navigation and Button Event Listeners
        // ===============================================
        let currentStep = 1;
        const totalSteps = 6;

        function updateProgressBar() {
            const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        function showStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(`step${stepNumber}`).classList.add('active');
            updateProgressBar();

            if (stepNumber === totalSteps) {
                document.getElementById('confetti-btn').classList.add('animate-pulse');
            }
            if (stepNumber === 4 && !starMapScene) {
                initStarMap();
            }
        }

        document.getElementById('start-btn').addEventListener('click', () => {
            currentStep = 2;
            showStep(currentStep);
        });

        document.getElementById('next-btn-2').addEventListener('click', () => {
            currentStep = 3;
            showStep(currentStep);
        });

        document.getElementById('next-btn-3').addEventListener('click', () => {
            currentStep = 4;
            showStep(currentStep);
        });

        document.getElementById('next-btn-4').addEventListener('click', () => {
            currentStep = 5;
            showStep(currentStep);
        });

        document.getElementById('start-blow-btn').addEventListener('click', () => {
            document.getElementById('start-blow-btn').disabled = true; // Prevent multiple clicks
            startBlowingLogic();
        });

        // New event listener for the manual blow button
        document.getElementById('manual-blow-btn').addEventListener('click', () => {
            blowOutCandles();
        });

        document.getElementById('next-btn-5').addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            currentStep = 6;
            showStep(currentStep);
        });

        // Confetti button
        document.getElementById('confetti-btn').addEventListener('click', () => {
            confetti({
                particleCount: 150,
                spread: 70,
                origin: {
                    y: 0.6
                },
                colors: ['#ff0000', '#ff69b4', '#ff1493', '#ffc0cb']
            });

            setTimeout(() => {
                confetti({
                    particleCount: 30,
                    spread: 60,
                    origin: {
                        y: 0.5
                    },
                    shapes: ['heart'],
                    colors: ['#ff0000', '#ff69b4']
                });
            }, 300);

            setTimeout(() => {
                confetti({
                    particleCount: 20,
                    angle: 60,
                    spread: 55,
                    origin: {
                        x: 0
                    },
                    shapes: ['heart'],
                    colors: ['#ff0000', '#ff69b4']
                });

                confetti({
                    particleCount: 20,
                    angle: 120,
                    spread: 55,
                    origin: {
                        x: 1
                    },
                    shapes: ['heart'],
                    colors: ['#ff0000', '#ff69b4']
                });
            }, 600);

            hearts.forEach(heart => {
                gsap.to(heart.position, {
                    y: heart.position.y - 30,
                    duration: 3,
                    ease: "power1.out"
                });
                gsap.to(heart.material, {
                    opacity: 0,
                    duration: 3,
                    ease: "power1.out"
                });
            });
        });

        updateProgressBar();
    </script>
</body>

</html>
